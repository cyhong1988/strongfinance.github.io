<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人資產管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 0.875rem; }
        .btn-delete { color: #ef4444; cursor: pointer; transition: opacity 0.2s; padding: 0 8px; }
        .drag-handle { cursor: grab; color: #475569; font-size: 1.2rem; user-select: none; padding-right: 8px; }
        
        /* 寬鬆版儲存按鈕 */
        .btn-save { 
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.4); 
            color: #60a5fa; 
            padding: 6px 24px; 
            border-radius: 99px; 
            font-size: 0.75rem; 
            letter-spacing: 0.2em;
            transition: all 0.3s; 
            margin-top: 12px;
            font-weight: 600;
        }
        .btn-save:hover { 
            background: rgba(59, 130, 246, 0.2); 
            border-color: #60a5fa;
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .btn-quick-add { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; transition: all 0.2s; margin-top: 6px; }
        .btn-quick-add:hover { background: rgba(59, 130, 246, 0.2); color: white; }
        .profit { color: #10b981; }
        .loss { color: #f43f5e; }

        .fx-tag {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 16px;
        }
    </style>
</head>
<body class="gradient-bg text-slate-200 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 border-b border-white/10 pb-10 gap-8">
            
            <div class="flex-1 text-center md:text-left">
                <h1 class="text-2xl font-light tracking-[0.3em] text-white">個人資產管理系統</h1>
                <div class="flex items-center justify-center md:justify-start gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="sync-status" class="text-slate-500 text-[10px] tracking-widest uppercase font-semibold">系統連線中</p>
                </div>
            </div>

            <div class="fx-tag flex flex-col items-center min-w-[160px]">
                <span class="text-[10px] text-slate-500 tracking-[0.2em] uppercase mb-1 font-bold">即時匯率參考</span>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-blue-400 font-bold">USD/TWD</span>
                    <span id="fx-rate-display" class="text-lg font-mono text-white font-medium">--.--</span>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center md:items-end">
                <span class="text-slate-500 text-[10px] uppercase tracking-[0.2em] mb-1 font-bold">當前總資產 (淨值)</span>
                <div class="flex items-baseline gap-2">
                    <span class="text-sm text-slate-400 font-mono">TWD</span>
                    <div id="total-assets-display" class="text-4xl font-mono font-bold text-white tracking-tighter">--</div>
                </div>
                <button onclick="saveData()" class="btn-save uppercase">同步雲端數據</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="space-y-6">
                <div class="card p-6 rounded-2xl border-t-2 border-red-500/50 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-slate-400 tracking-widest uppercase">現金流清單</h2>
                        <button onclick="addRow()" class="text-[10px] text-slate-500 hover:text-white transition">+ 新增項目</button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">每月固定收入</label>
                        <input type="number" id="input-income" class="input-field border-emerald-900/30 font-mono text-emerald-400" value="146000" oninput="calculate()">
                    </div>
                    <div id="expense-list" class="space-y-2 min-h-[50px]"></div>
                    <div class="mt-8 pt-4 border-t border-white/5">
                        <div class="flex justify-between items-end">
                            <div>
                                <span class="text-slate-500 text-[10px] uppercase tracking-wider">每月收支缺口</span>
                                <div id="monthly-gap-display" class="text-2xl font-mono font-bold text-red-400/80">--</div>
                            </div>
                            <div class="text-right">
                                <span class="text-slate-500 text-[10px] uppercase tracking-wider">總預算</span>
                                <div id="total-expense-display" class="text-xs font-mono text-slate-400">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl border-t-2 border-emerald-500/50">
                    <h2 class="text-xs font-bold text-slate-400 tracking-widest mb-4 uppercase">年度大型預留支出(出國旅遊)</h2>
                    <input type="number" id="input-travel" class="input-field font-mono text-lg" value="400000" oninput="calculate()">
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-5 rounded-2xl">
                        <label class="text-[10px] text-slate-500 uppercase tracking-widest block mb-2 font-bold">流動現金總額</label>
                        <input type="number" id="input-cash" class="input-field text-xl font-mono text-emerald-400/90" value="4600000" oninput="calculate()">
                    </div>
                    <div class="card p-5 rounded-2xl">
                        <label class="text-[10px] text-slate-500 uppercase tracking-widest block mb-2 font-bold">尚餘加碼彈藥</label>
                        <input type="number" id="input-ammo" class="input-field text-xl font-mono text-amber-400/90" value="1000000" oninput="calculate()">
                    </div>
                </div>

                <div class="card p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-10">資產建倉進度與實時損益</h2>
                    
                    <div class="space-y-14">
                        <div class="space-y-4">
                            <div class="flex justify-between items-end border-b border-white/5 pb-3">
                                <span class="text-sm font-bold text-blue-400 tracking-widest">美股配置 (250萬)</span>
                                <div class="flex gap-8 items-center">
                                    <div class="text-right">
                                        <label class="text-[10px] text-slate-500 uppercase block font-bold">損益 (USD)</label>
                                        <input type="number" id="pnl-us-usd" class="input-field w-24 font-mono text-right text-sm" value="0" step="0.01" oninput="calculate()">
                                    </div>
                                    <div class="text-right border-l border-white/10 pl-6">
                                        <label class="text-[10px] text-slate-500 uppercase block font-bold">折合台幣</label>
                                        <div id="pnl-us-twd-display" class="text-md font-mono font-bold">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                                <div>
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">核心 1倍 ETF (200萬)</label>
                                    <input type="number" id="input-us-1x" class="input-field font-mono" value="0" oninput="calculate()">
                                    <button onclick="quickAdd('input-us-1x', 200000)" class="btn-quick-add w-full">+ 20萬 (月)</button>
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">衛星 槓桿 ETF (50萬)</label>
                                    <input type="number" id="input-us-nx" class="input-field font-mono" value="0" oninput="calculate()">
                                    <button onclick="quickAdd('input-us-nx', 100000)" class="btn-quick-add w-full">+ 10萬 (月)</button>
                                </div>
                            </div>
                            <div id="us-time-tag" class="text-[10px] text-slate-500 font-mono italic text-right tracking-wider">--</div>
                            <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden flex">
                                <div id="bar-us-1x" class="bg-blue-500 h-full transition-all duration-1000" style="width: 0%"></div>
                                <div id="bar-us-nx" class="bg-cyan-400 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-end border-b border-white/5 pb-3">
                                <span class="text-sm font-bold text-purple-400 tracking-widest">台股配置 (500萬)</span>
                                <div class="text-right">
                                    <label class="text-[10px] text-slate-500 uppercase block font-bold">目前總損益 (TWD)</label>
                                    <input type="number" id="pnl-tw" class="input-field w-32 font-mono text-right text-sm" value="0" oninput="calculate()">
                                </div>
                            </div>
                            <div class="flex gap-4 pt-2">
                                <div class="flex-grow">
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">已投入本金</label>
                                    <input type="number" id="input-tw" class="input-field font-mono" value="0" oninput="calculate()">
                                </div>
                                <button onclick="quickAdd('input-tw', 50000)" class="btn-quick-add whitespace-nowrap px-8 self-end font-semibold">+ 5萬 (週)</button>
                            </div>
                            <div id="tw-time-tag" class="text-[10px] text-slate-500 font-mono italic text-right tracking-wider">--</div>
                            <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden">
                                <div id="bar-tw" class="bg-purple-500 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">現金尚可存活</h3>
                        <div id="survival-result" class="text-3xl font-mono font-light text-white">--</div>
                    </div>
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">台股預計完成建倉進度</h3>
                        <div id="tw-time-result" class="text-xl font-mono text-slate-300">--</div>
                    </div>
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">美股預計完成建倉進度</h3>
                        <div id="us-time-result" class="text-xl font-mono text-cyan-500/80">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'YOUR_GAS_URL'; 
        let currentFxRate = 32.5;

        async function fetchFxRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.TWD) {
                    currentFxRate = data.rates.TWD;
                    document.getElementById('fx-rate-display').innerText = currentFxRate.toFixed(2);
                    calculate();
                }
            } catch (e) {
                document.getElementById('fx-rate-display').innerText = "32.50 (估)";
            }
        }

        function initSortable() {
            const el = document.getElementById('expense-list');
            Sortable.create(el, { animation: 150, handle: '.drag-handle', onEnd: () => calculate() });
        }

        function quickAdd(id, amount) {
            const input = document.getElementById(id);
            input.value = (parseFloat(input.value) || 0) + amount;
            calculate();
        }

        function formatTime(totalWeeks) {
            if (totalWeeks <= 0) return "已完工";
            const months = Math.floor(totalWeeks / 4);
            const weeks = totalWeeks % 4;
            return (months > 0 ? `${months}個月 ` : "") + (weeks > 0 ? `${weeks}週` : "");
        }

        function addRow(name = '', amount = '') {
            const container = document.getElementById('expense-list');
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center expense-row bg-white/5 p-2 rounded-lg';
            row.innerHTML = `<div class="drag-handle text-slate-600">⋮</div><input type="text" class="input-field exp-name text-xs" value="${name}"><input type="number" class="input-field exp-amount w-20 font-mono text-right text-xs" value="${amount}" oninput="calculate()"><span class="btn-delete" onclick="this.parentElement.remove(); calculate();">✕</span>`;
            container.appendChild(row);
            calculate();
        }

        function calculate() {
            const income = parseFloat(document.getElementById('input-income').value) || 0;
            const cash = parseFloat(document.getElementById('input-cash').value) || 0;
            const travel = parseFloat(document.getElementById('input-travel').value) || 0;
            const us1x = parseFloat(document.getElementById('input-us-1x').value) || 0;
            const usNx = parseFloat(document.getElementById('input-us-nx').value) || 0;
            const tw = parseFloat(document.getElementById('input-tw').value) || 0;
            const pnlUsUsd = parseFloat(document.getElementById('pnl-us-usd').value) || 0;
            const pnlTw = parseFloat(document.getElementById('pnl-tw').value) || 0;

            const pnlUsTwd = pnlUsUsd * currentFxRate;
            const usTwdDisplay = document.getElementById('pnl-us-twd-display');
            usTwdDisplay.innerText = Math.floor(pnlUsTwd).toLocaleString();
            usTwdDisplay.className = `text-md font-mono mt-1 font-bold ${pnlUsUsd >= 0 ? 'profit' : 'loss'}`;
            document.getElementById('pnl-tw').className = `input-field w-32 font-mono text-right text-sm ${pnlTw >= 0 ? 'profit' : 'loss'}`;

            const totalAssets = cash + tw + us1x + usNx + pnlUsTwd + pnlTw;
            document.getElementById('total-assets-display').innerText = Math.floor(totalAssets).toLocaleString();

            let totalExp = 0;
            document.querySelectorAll('.exp-amount').forEach(i => totalExp += parseFloat(i.value) || 0);
            const gap = totalExp - income;
            document.getElementById('total-expense-display').innerText = totalExp.toLocaleString();
            document.getElementById('monthly-gap-display').innerText = gap.toLocaleString();

            const annualDrain = (gap * 12) + travel;
            document.getElementById('survival-result').innerText = (annualDrain > 0 ? (cash / annualDrain).toFixed(2) : "∞") + " 年";

            const twWeeks = Math.max(0, Math.ceil((5000000 - tw) / 50000));
            document.getElementById('tw-time-result').innerText = formatTime(twWeeks);
            document.getElementById('tw-time-tag').innerText = "預計完工: " + formatTime(twWeeks);
            document.getElementById('bar-tw').style.width = Math.min((tw / 5000000) * 100, 100) + "%";

            const u1W = Math.max(0, Math.ceil((2000000 - us1x) / 50000));
            const uNW = Math.max(0, Math.ceil((500000 - usNx) / 25000));
            const usMaxW = Math.max(u1W, uNW);
            document.getElementById('us-time-result').innerText = formatTime(usMaxW);
            document.getElementById('us-time-tag').innerText = "預計完工: " + formatTime(usMaxW);
            document.getElementById('bar-us-1x').style.width = Math.min((us1x / 2500000) * 100, 80) + "%";
            document.getElementById('bar-us-nx').style.width = Math.min((usNx / 2500000) * 100, 20) + "%";
        }

        async function saveData() {
            const status = document.getElementById('sync-status');
            status.innerText = "正在儲存...";
            const data = {
                income: document.getElementById('input-income').value,
                cash: document.getElementById('input-cash').value,
                ammo: document.getElementById('input-ammo').value,
                travel: document.getElementById('input-travel').value,
                us1x: document.getElementById('input-us-1x').value,
                usNx: document.getElementById('input-us-nx').value,
                tw: document.getElementById('input-tw').value,
                pnlUsUsd: document.getElementById('pnl-us-usd').value,
                pnlTw: document.getElementById('pnl-tw').value,
                expenses: Array.from(document.querySelectorAll('.expense-row')).map(r => ({
                    name: r.querySelector('.exp-name').value,
                    amount: r.querySelector('.exp-amount').value
                }))
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                status.innerText = "已儲存雲端";
                setTimeout(() => status.innerText = "系統連線中", 3000);
            } catch (e) { status.innerText = "儲存失敗"; }
        }

        async function loadData() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                if (data.income) {
                    document.getElementById('input-income').value = data.income;
                    document.getElementById('input-cash').value = data.cash;
                    document.getElementById('input-ammo').value = data.ammo;
                    document.getElementById('input-travel').value = data.travel;
                    document.getElementById('input-us-1x').value = data.us1x || 0;
                    document.getElementById('input-us-nx').value = data.usNx || 0;
                    document.getElementById('input-tw').value = data.tw;
                    document.getElementById('pnl-us-usd').value = data.pnlUsUsd || 0;
                    document.getElementById('pnl-tw').value = data.pnlTw || 0;
                    document.getElementById('expense-list').innerHTML = '';
                    data.expenses.forEach(ex => addRow(ex.name, ex.amount));
                    calculate();
                }
            } catch (e) { addRow('房貸', 100000); addRow('生活費', 40000); }
        }

        window.onload = () => { fetchFxRate(); loadData(); initSortable(); };
    </script>
</body>
</html>


// Google Apps Script 後端程式碼

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Data");
  
  // 解析傳入的 JSON 數據
  var data = JSON.parse(e.postData.contents);
  
  // 準備儲存的時間戳記
  var timestamp = new Date();
  
  // 這裡我們簡單地將整份 JSON 存入單一儲存格，方便擴充
  // 如果舊資料存在則更新，不存在則新增
  var lastRow = sheet.getLastRow();
  var found = false;
  
  if (lastRow > 1) {
    var range = sheet.getRange(2, 1, lastRow - 1, 1);
    var values = range.getValues();
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == "CURRENT_CONFIG") {
        sheet.getRange(i + 2, 2).setValue(timestamp);
        sheet.getRange(i + 2, 3).setValue(JSON.stringify(data));
        found = true;
        break;
      }
    }
  }
  
  if (!found) {
    sheet.appendRow(["CURRENT_CONFIG", timestamp, JSON.stringify(data)]);
  }
  
  return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
}

function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Data");
  var lastRow = sheet.getLastRow();
  
  var result = {};
  
  if (lastRow > 1) {
    var range = sheet.getRange(2, 1, lastRow - 1, 3);
    var values = range.getValues();
    for (var i = 0; i < values.length; i++) {
      if (values[i][0] == "CURRENT_CONFIG") {
        result = JSON.parse(values[i][2]);
        break;
      }
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}
