<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人投資戰略系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 0.875rem; }
        .input-readonly { background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(51, 65, 85, 0.3); color: #94a3b8; cursor: not-allowed; }
        .btn-delete { color: #ef4444; cursor: pointer; transition: opacity 0.2s; padding: 0 8px; }
        .drag-handle { cursor: grab; color: #475569; font-size: 1.2rem; user-select: none; padding-right: 8px; }
        
        .btn-save { 
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.4); 
            color: #60a5fa; 
            padding: 6px 24px; 
            border-radius: 99px; 
            font-size: 0.75rem; 
            letter-spacing: 0.2em;
            transition: all 0.3s; 
            margin-top: 12px;
            font-weight: 600;
        }
        .btn-save:hover { 
            background: rgba(59, 130, 246, 0.2); 
            border-color: #60a5fa;
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .btn-quick-add { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; transition: all 0.2s; margin-top: 6px; }
        .btn-quick-add:hover { background: rgba(59, 130, 246, 0.2); color: white; }
        .profit { color: #10b981; }
        .loss { color: #f43f5e; }

        .fx-tag {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 16px;
        }
    </style>
</head>
<body class="gradient-bg text-slate-200 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 border-b border-white/10 pb-10 gap-8">
            <div class="flex-1 text-center md:text-left">
                <h1 class="text-2xl font-light tracking-[0.3em] text-white">個人投資戰略系統</h1>
                <div class="flex items-center justify-center md:justify-start gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="sync-status" class="text-slate-500 text-[10px] tracking-widest uppercase font-semibold">系統連線中</p>
                </div>
            </div>

            <div class="fx-tag flex flex-col items-center min-w-[160px]">
                <span class="text-[10px] text-slate-500 tracking-[0.2em] uppercase mb-1 font-bold">即時匯率參考</span>
                <div class="flex items-center gap-3">
                    <span class="text-xs text-blue-400 font-bold">USD/TWD</span>
                    <span id="fx-rate-display" class="text-lg font-mono text-white font-medium">--.--</span>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center md:items-end">
                <span class="text-slate-500 text-[10px] uppercase tracking-[0.2em] mb-1 font-bold">當前總資產 (淨值)</span>
                <div class="flex items-baseline gap-2">
                    <span class="text-sm text-slate-400 font-mono">TWD</span>
                    <div id="total-assets-display" class="text-4xl font-mono font-bold text-white tracking-tighter">--</div>
                </div>
                <br>
                <button onclick="saveData()" class="btn-save uppercase">儲存並更新</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="space-y-6">
                <div class="card p-6 rounded-2xl border-t-2 border-red-500/50 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-slate-400 tracking-widest uppercase">現金流清單</h2>
                        <button onclick="addRow('expense')" class="text-[10px] text-slate-500 hover:text-white transition">+ 新增項目</button>
                    </div>
                    <div class="space-y-3 mb-6">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">每月固定收入</label>
                            <input type="number" id="input-income" class="input-field border-emerald-900/30 font-mono text-emerald-400" placeholder="請輸入金額" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 uppercase tracking-wider">每月固定支出 (自動加總)</label>
                            <input type="text" id="display-total-expense" class="input-field input-readonly font-mono text-red-400/80" placeholder="--" readonly>
                        </div>
                    </div>
                    
                    <div id="expense-list" class="space-y-2 min-h-[50px]"></div>
                    
                    <div class="mt-8 pt-4 border-t border-white/5">
                        <div class="flex justify-between items-end">
                            <div>
                                <span class="text-slate-500 text-[10px] uppercase tracking-wider">每月收支報告</span>
                                <div id="monthly-gap-display" class="text-2xl font-mono font-bold">--</div>
                            </div>
                            <div class="text-right">
                                <span class="text-slate-500 text-[10px] uppercase tracking-wider">年度固定支出預算</span>
                                <div id="annual-expense-display" class="text-xs font-mono text-slate-400">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-2xl border-t-2 border-slate-500/50">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-slate-400 tracking-widest uppercase">目前出國旅遊支出</h2>
                        <span class="text-[9px] text-slate-500 uppercase tracking-tighter">僅紀錄</span>
                    </div>
                    <input type="number" id="input-travel" class="input-field font-mono text-lg text-slate-400" placeholder="請輸入金額" oninput="calculate()">
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">流動現金總額 (自動加總)</label>
                            <button onclick="addRow('bank')" class="text-[9px] bg-white/5 px-2 py-1 rounded hover:bg-white/10">+ 新增銀行</button>
                        </div>
                        <input type="text" id="input-cash" class="input-field input-readonly text-2xl font-mono text-emerald-400/90 mb-4" placeholder="--" readonly>
                        <div id="bank-list" class="space-y-2 max-h-[300px] overflow-y-auto pr-1"></div>
                    </div>

                    <div class="card p-6 rounded-2xl flex flex-col justify-between">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase tracking-widest block mb-2 font-bold">尚餘加碼彈藥</label>
                            <input type="number" id="input-ammo" class="input-field text-xl font-mono text-amber-400/90" placeholder="請輸入金額" oninput="calculate()">
                        </div>
                        <p class="text-[9px] text-slate-500 italic mt-4">此欄位手動填寫，不計入上方自動加總。</p>
                    </div>
                </div>

                <div class="card p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-10">資產建倉進度與實時損益</h2>
                    <div class="space-y-14">
                        <div class="space-y-4">
                            <div class="flex justify-between items-end border-b border-white/5 pb-3">
                                <span class="text-sm font-bold text-blue-400 tracking-widest">美股配置 (250萬)</span>
                                <div class="flex gap-8 items-center">
                                    <div class="text-right">
                                        <label class="text-[10px] text-slate-500 uppercase block font-bold">損益 (USD)</label>
                                        <input type="number" id="pnl-us-usd" class="input-field w-24 font-mono text-right text-sm" placeholder="空白" step="0.01" oninput="calculate()">
                                    </div>
                                    <div class="text-right border-l border-white/10 pl-6">
                                        <label class="text-[10px] text-slate-500 uppercase block font-bold">折合台幣</label>
                                        <div id="pnl-us-twd-display" class="text-md font-mono font-bold">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                                <div>
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">核心 1倍 ETF (200萬)</label>
                                    <input type="number" id="input-us-1x" class="input-field font-mono" placeholder="請輸入本金" oninput="calculate()">
                                    <button onclick="quickAdd('input-us-1x', 200000)" class="btn-quick-add w-full">+ 20萬 (月)</button>
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">衛星 槓桿 ETF (50萬)</label>
                                    <input type="number" id="input-us-nx" class="input-field font-mono" placeholder="請輸入本金" oninput="calculate()">
                                    <button onclick="quickAdd('input-us-nx', 100000)" class="btn-quick-add w-full">+ 10萬 (月)</button>
                                </div>
                            </div>
                            <div id="us-time-tag" class="text-[10px] text-slate-500 font-mono italic text-right tracking-wider">--</div>
                            <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden flex">
                                <div id="bar-us-1x" class="bg-blue-500 h-full transition-all duration-1000" style="width: 0%"></div>
                                <div id="bar-us-nx" class="bg-cyan-400 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-end border-b border-white/5 pb-3">
                                <span class="text-sm font-bold text-purple-400 tracking-widest">台股配置 (500萬)</span>
                                <div class="text-right">
                                    <label class="text-[10px] text-slate-500 uppercase block font-bold">目前總損益 (TWD)</label>
                                    <input type="number" id="pnl-tw" class="input-field w-32 font-mono text-right text-sm" placeholder="空白" oninput="calculate()">
                                </div>
                            </div>
                            <div class="flex gap-4 pt-2">
                                <div class="flex-grow">
                                    <label class="text-[10px] text-slate-500 mb-1 block uppercase">已投入本金</label>
                                    <input type="number" id="input-tw" class="input-field font-mono" placeholder="請輸入本金" oninput="calculate()">
                                </div>
                                <button onclick="quickAdd('input-tw', 50000)" class="btn-quick-add whitespace-nowrap px-8 self-end font-semibold">+ 5萬 (週)</button>
                            </div>
                            <div id="tw-time-tag" class="text-[10px] text-slate-500 font-mono italic text-right tracking-wider">--</div>
                            <div class="w-full bg-white/5 h-2 rounded-full overflow-hidden">
                                <div id="bar-tw" class="bg-purple-500 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">現金尚可支撐年限</h3>
                        <div id="survival-result" class="text-3xl font-mono font-light text-white">--</div>
                    </div>
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">台股建倉完成預估</h3>
                        <div id="tw-time-result" class="text-xl font-mono text-slate-300">--</div>
                    </div>
                    <div class="card p-6 rounded-2xl border border-white/5 text-center">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">美股建倉完成預估</h3>
                        <div id="us-time-result" class="text-xl font-mono text-cyan-500/80">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxbYPyWLw2Da1goYFISnTpsSGfnuxNGEkhJIOU2iozNDQA7xnVROFjBM5rKj98foX0h/exec'; 
        let currentFxRate = 32.5;

        // 小助手：強制將 0 或 null 轉換為空字串以保持欄位空白
        const emptyIfZero = (val) => (val == 0 || val === null || val === undefined) ? "" : val;

        async function fetchFxRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data?.rates?.TWD) {
                    currentFxRate = data.rates.TWD;
                    document.getElementById('fx-rate-display').innerText = currentFxRate.toFixed(2);
                    calculate();
                }
            } catch (e) {
                document.getElementById('fx-rate-display').innerText = "32.50 (估)";
            }
        }

        function initSortable() {
            Sortable.create(document.getElementById('expense-list'), { animation: 150, handle: '.drag-handle', onEnd: () => calculate() });
        }

        function quickAdd(id, amount) {
            const input = document.getElementById(id);
            input.value = (parseFloat(input.value) || 0) + amount;
            calculate();
        }

        function formatTime(totalWeeks) {
            if (totalWeeks <= 0) return "已完工";
            const months = Math.floor(totalWeeks / 4);
            const weeks = totalWeeks % 4;
            return (months > 0 ? `${months}個月 ` : "") + (weeks > 0 ? `${weeks}週` : "");
        }

        function addRow(type, name = '', amount = '') {
            const container = document.getElementById(type === 'bank' ? 'bank-list' : 'expense-list');
            const row = document.createElement('div');
            row.className = `flex gap-2 items-center ${type}-row bg-white/5 p-2 rounded-lg mb-1`;
            const nameClass = type === 'bank' ? 'bank-name' : 'exp-name';
            const amountClass = type === 'bank' ? 'bank-amount' : 'exp-amount';
            
            row.innerHTML = `
                <div class="drag-handle text-slate-600">⋮</div>
                <input type="text" class="input-field ${nameClass} text-xs" value="${name}" placeholder="${type === 'bank' ? '銀行名稱' : '項目'}">
                <input type="number" class="input-field ${amountClass} w-24 font-mono text-right text-xs" value="${emptyIfZero(amount)}" placeholder="金額" oninput="calculate()">
                <span class="btn-delete" onclick="this.parentElement.remove(); calculate();">✕</span>`;
            container.appendChild(row);
            calculate();
        }

        function calculate() {
            let totalBankCash = 0;
            document.querySelectorAll('.bank-amount').forEach(i => {
                const val = parseFloat(i.value);
                if (!isNaN(val)) totalBankCash += val;
            });
            document.getElementById('input-cash').value = totalBankCash === 0 ? "" : Math.floor(totalBankCash).toLocaleString();

            const income = parseFloat(document.getElementById('input-income').value) || 0;
            const cash = totalBankCash;
            const us1x = parseFloat(document.getElementById('input-us-1x').value) || 0;
            const usNx = parseFloat(document.getElementById('input-us-nx').value) || 0;
            const tw = parseFloat(document.getElementById('input-tw').value) || 0;
            const pnlUsUsd = parseFloat(document.getElementById('pnl-us-usd').value) || 0;
            const pnlTw = parseFloat(document.getElementById('pnl-tw').value) || 0;

            const pnlUsTwd = pnlUsUsd * currentFxRate;
            document.getElementById('pnl-us-twd-display').innerText = pnlUsUsd === 0 ? "--" : Math.floor(pnlUsTwd).toLocaleString();
            document.getElementById('pnl-us-twd-display').className = `text-md font-mono mt-1 font-bold ${pnlUsUsd >= 0 ? 'profit' : 'loss'}`;

            const totalAssets = cash + tw + us1x + usNx + pnlUsTwd + pnlTw;
            document.getElementById('total-assets-display').innerText = totalAssets === 0 ? "--" : Math.floor(totalAssets).toLocaleString();

            let totalExp = 0;
            document.querySelectorAll('.exp-amount').forEach(i => {
                const val = parseFloat(i.value);
                if (!isNaN(val)) totalExp += val;
            });
            document.getElementById('display-total-expense').value = totalExp === 0 ? "" : totalExp.toLocaleString();
            
            const balance = income - totalExp;
            const gapDisplay = document.getElementById('monthly-gap-display');
            
            if (balance > 0) {
                gapDisplay.innerText = "+" + balance.toLocaleString();
                gapDisplay.className = "text-2xl font-mono font-bold profit"; 
            } else if (balance < 0) {
                gapDisplay.innerText = "-" + Math.abs(balance).toLocaleString();
                gapDisplay.className = "text-2xl font-mono font-bold loss";
            } else {
                gapDisplay.innerText = "0";
                gapDisplay.className = "text-2xl font-mono font-bold text-slate-400";
            }

            document.getElementById('annual-expense-display').innerText = totalExp === 0 ? "--" : (totalExp * 12).toLocaleString();

            const gap = totalExp - income;
            if (gap <= 0) {
                document.getElementById('survival-result').innerText = "∞";
                document.getElementById('survival-result').className = "text-3xl font-mono font-light text-emerald-400";
            } else if (cash === 0) {
                document.getElementById('survival-result').innerText = "0天";
                document.getElementById('survival-result').className = "text-3xl font-mono font-light loss";
            } else {
                let totalMonths = cash / gap;
                const years = Math.floor(totalMonths / 12);
                const remainingMonths = Math.floor(totalMonths % 12);
                const remainingDays = Math.floor((totalMonths - Math.floor(totalMonths)) * 30.44);
                
                let timeStr = "";
                if (years > 0) timeStr += `${years}年`;
                if (remainingMonths > 0) timeStr += `${remainingMonths}個月`;
                timeStr += `又${remainingDays}天`;
                
                document.getElementById('survival-result').innerText = timeStr;
                document.getElementById('survival-result').className = totalMonths < 6 ? "text-2xl font-mono font-bold loss" : "text-2xl font-mono font-bold text-white";
            }

            const twWeeks = Math.max(0, Math.ceil((5000000 - tw) / 50000));
            document.getElementById('tw-time-result').innerText = tw === 0 ? "--" : formatTime(twWeeks);
            document.getElementById('bar-tw').style.width = Math.min((tw / 5000000) * 100, 100) + "%";

            const u1W = Math.max(0, Math.ceil((2000000 - us1x) / 50000));
            const uNW = Math.max(0, Math.ceil((500000 - usNx) / 25000));
            const usMaxW = Math.max(u1W, uNW);
            document.getElementById('us-time-result').innerText = (us1x === 0 && usNx === 0) ? "--" : formatTime(usMaxW);
            document.getElementById('bar-us-1x').style.width = Math.min((us1x / 2500000) * 100, 80) + "%";
            document.getElementById('bar-us-nx').style.width = Math.min((usNx / 2500000) * 100, 20) + "%";
        }

        async function saveData() {
            const status = document.getElementById('sync-status');
            status.innerText = "正在儲存...";
            const data = {
                income: document.getElementById('input-income').value,
                ammo: document.getElementById('input-ammo').value,
                travel: document.getElementById('input-travel').value,
                us1x: document.getElementById('input-us-1x').value,
                usNx: document.getElementById('input-us-nx').value,
                tw: document.getElementById('input-tw').value,
                pnlUsUsd: document.getElementById('pnl-us-usd').value,
                pnlTw: document.getElementById('pnl-tw').value,
                banks: Array.from(document.querySelectorAll('.bank-row')).map(r => ({
                    name: r.querySelector('.bank-name').value,
                    amount: r.querySelector('.bank-amount').value
                })),
                expenses: Array.from(document.querySelectorAll('.expense-row')).map(r => ({
                    name: r.querySelector('.exp-name').value,
                    amount: r.querySelector('.exp-amount').value
                }))
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                status.innerText = "已儲存雲端";
                setTimeout(() => status.innerText = "系統連線中", 3000);
            } catch (e) { status.innerText = "儲存失敗"; }
        }

        async function loadData() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                if (data && data.income !== undefined) {
                    // 使用 emptyIfZero 確保如果是 0 則顯示空白
                    document.getElementById('input-income').value = emptyIfZero(data.income);
                    document.getElementById('input-ammo').value = emptyIfZero(data.ammo);
                    document.getElementById('input-travel').value = emptyIfZero(data.travel);
                    document.getElementById('input-us-1x').value = emptyIfZero(data.us1x);
                    document.getElementById('input-us-nx').value = emptyIfZero(data.usNx);
                    document.getElementById('input-tw').value = emptyIfZero(data.tw);
                    document.getElementById('pnl-us-usd').value = emptyIfZero(data.pnlUsUsd);
                    document.getElementById('pnl-tw').value = emptyIfZero(data.pnlTw);
                    
                    document.getElementById('bank-list').innerHTML = '';
                    if (data.banks?.length > 0) {
                        data.banks.forEach(b => addRow('bank', b.name, emptyIfZero(b.amount)));
                    } else {
                        ['中信','樂天','王道','上海商銀','台新'].forEach(n => addRow('bank', n, ''));
                    }
                    
                    document.getElementById('expense-list').innerHTML = '';
                    if (data.expenses?.length > 0) {
                        data.expenses.forEach(ex => addRow('expense', ex.name, emptyIfZero(ex.amount)));
                    }
                    calculate();
                }
            } catch (e) { 
                ['中信','樂天','王道','上海商銀','台新'].forEach(n => addRow('bank', n, ''));
            }
        }

        window.onload = () => { fetchFxRate(); loadData(); initSortable(); };
    </script>
</body>
</html>
